<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Say the Word on Beat - 8 Cards Edition</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-color: #00ff88;
            --highlight-color: #ff0055;
            --card-bg: #2d2d2d;
            --secondary-color: #4a4a4a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 5px; text-shadow: 0 0 10px var(--accent-color); }
        .subtitle { color: #888; margin-bottom: 20px; font-size: 0.9em; }

        .controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            text-align: center;
            width: 90%;
            max-width: 600px;
        }

        /* é—œå¡æ§åˆ¶å€ */
        .level-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 15px 0;
            display: none; /* é è¨­éš±è— */
        }

        .level-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .nav-btn {
            background-color: var(--secondary-color);
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .nav-btn:hover { background-color: #666; }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .input-group { margin: 15px 0; display: flex; flex-direction: column; align-items: center; }
        input[type="file"] { display: none; }
        
        .custom-file-upload {
            border: 2px dashed var(--accent-color);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            display: inline-block;
        }
        .custom-file-upload:hover { background-color: rgba(0, 255, 136, 0.1); }

        button#startBtn {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
            transition: transform 0.1s;
        }
        button#startBtn:active { transform: scale(0.95); }

        /* ç¶²æ ¼è¨­å®šï¼šå¼·åˆ¶ 4 åˆ—ï¼Œé€™æ¨£ 8 å¼µåœ–æœƒå‰›å¥½è®Šæˆ 2 è¡Œ */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px;
            width: 90%;
            max-width: 800px;
        }

        .card {
            background: var(--card-bg);
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            border: 4px solid transparent;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card img { width: 100%; height: 100%; object-fit: cover; }

        .card.active {
            border-color: var(--highlight-color);
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--highlight-color);
            z-index: 10;
        }

        .slider-container { margin-top: 15px; display: flex; justify-content: center; gap: 10px; align-items: center; }
        
        .beat-indicator {
            width: 15px; height: 15px; border-radius: 50%;
            background-color: #333; margin: 10px auto;
        }
        .beat-indicator.pulse { background-color: var(--highlight-color); box-shadow: 0 0 10px var(--highlight-color); }

    </style>
</head>
<body>

    <h1>Say the Word on Beat ğŸµ</h1>
    <div class="subtitle">å›ºå®š 8 å¼µåœ–ç‰‡ / é—œ</div>

    <div class="controls">
        <!-- ä¸Šå‚³å€ -->
        <div class="input-group">
            <label for="imageLoader" class="custom-file-upload">
                ğŸ“‚ é»æ“Šé¸æ“‡åœ–ç‰‡ (ä¾‹å¦‚ 40 å¼µ)
            </label>
            <input type="file" id="imageLoader" name="imageLoader" accept="image/*" multiple/>
            <div id="file-count" style="margin-top:5px; color:#aaa; font-size:0.9em;">æœªé¸æ“‡åœ–ç‰‡</div>
        </div>

        <!-- é—œå¡æ§åˆ¶ -->
        <div id="level-controls" class="level-controls">
            <button class="nav-btn" id="prevBtn" onclick="changeLevel(-1)">â—€ ä¸Šä¸€é—œ</button>
            <span class="level-title" id="current-level-display">LEVEL 1</span>
            <button class="nav-btn" id="nextBtn" onclick="changeLevel(1)">ä¸‹ä¸€é—œ â–¶</button>
        </div>

        <!-- éŠæˆ²æ§åˆ¶ -->
        <div class="slider-container">
            <label>é€Ÿåº¦ (BPM): <span id="bpm-val">100</span></label>
            <input type="range" id="bpm" min="60" max="180" value="100" oninput="updateBPM(this.value)">
        </div>

        <div class="beat-indicator" id="beat-dot"></div>
        <button id="startBtn" onclick="toggleGame()">é–‹å§‹éŠæˆ² (Start)</button>
    </div>

    <div class="game-grid" id="grid"></div>

    <script>
        // è¨­å®šå¸¸æ•¸ï¼šæ¯é—œå›ºå®š 8 å¼µ
        const PHOTOS_PER_LEVEL = 8;

        let allImageFiles = []; 
        let levelChunks = [];
        let currentLevelIndex = 0;

        let isPlaying = false;
        let audioContext = null;
        let currentStep = 0; 
        let nextNoteTime = 0.0;
        let timerID = null;
        let tempo = 100;
        const scheduleAheadTime = 0.1;

        document.getElementById('imageLoader').addEventListener('change', handleImageUpload);

        function updateBPM(val) {
            tempo = val;
            document.getElementById('bpm-val').innerText = val;
        }

        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            if(!files.length) return;

            document.getElementById('file-count').innerText = `å·²è¼‰å…¥ ${files.length} å¼µåœ–ç‰‡`;
            
            allImageFiles = files;
            levelChunks = [];
            currentLevelIndex = 0;
            stopGame();

            // === æ ¸å¿ƒä¿®æ”¹é‚è¼¯ï¼šæ¯ 8 å¼µåˆ‡ä¸€åˆ€ ===
            for (let i = 0; i < files.length; i += PHOTOS_PER_LEVEL) {
                const chunk = files.slice(i, i + PHOTOS_PER_LEVEL);
                levelChunks.push(chunk);
            }

            document.getElementById('level-controls').style.display = 'flex';
            renderLevel(0);
        }

        function renderLevel(levelIndex) {
            // å®‰å…¨æª¢æŸ¥
            if (levelIndex < 0) levelIndex = 0;
            if (levelIndex >= levelChunks.length) levelIndex = levelChunks.length - 1;
            
            currentLevelIndex = levelIndex;
            
            // æ›´æ–° UI
            document.getElementById('current-level-display').innerText = `LEVEL ${currentLevelIndex + 1} / ${levelChunks.length}`;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('prevBtn').disabled = (currentLevelIndex === 0);
            document.getElementById('nextBtn').disabled = (currentLevelIndex === levelChunks.length - 1);

            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const currentImages = levelChunks[currentLevelIndex];
            
            // å¦‚æœé€™é—œä¸è¶³ 4 å¼µï¼Œèª¿æ•´ç¶²æ ¼é¡¯ç¤ºï¼Œå¦å‰‡ç¶­æŒ 4 åˆ— (8å¼µå°±æ˜¯ 2è¡Œx4åˆ—)
            if(currentImages.length <= 4 && currentImages.length > 0) {
                 grid.style.gridTemplateColumns = `repeat(${currentImages.length}, 1fr)`;
            } else {
                 grid.style.gridTemplateColumns = `repeat(4, 1fr)`;
            }

            currentImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const div = document.createElement('div');
                    div.className = 'card';
                    
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    div.appendChild(img);
                    grid.appendChild(div);
                }
                reader.readAsDataURL(file);
            });

            currentStep = 0;
        }

        function changeLevel(direction) {
            const newIndex = currentLevelIndex + direction;
            if (newIndex >= 0 && newIndex < levelChunks.length) {
                stopGame(); // åˆ‡æ›é—œå¡æ™‚å¼·åˆ¶åœæ­¢
                renderLevel(newIndex);
            }
        }

        // --- Audio & Game Logic ---
        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
        }

        function playSound(time, pitch) {
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(pitch, time);
            gainNode.gain.setValueAtTime(0.1, time);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
            osc.start(time);
            osc.stop(time + 0.1);
        }

        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleNote(currentStep, nextNoteTime);
                nextNote();
            }
            if (isPlaying) timerID = requestAnimationFrame(scheduler);
        }

        function nextNote() {
            const secondsPerBeat = 60.0 / tempo;
            nextNoteTime += secondsPerBeat;
            currentStep++;
            const currentLevelCount = levelChunks[currentLevelIndex].length;
            if (currentStep >= currentLevelCount) {
                currentStep = 0;
            }
        }

        function scheduleNote(stepIndex, time) {
            // ç¬¬ä¸€æ‹é«˜éŸ³ï¼Œå…¶ä»–ä½éŸ³
            playSound(time, stepIndex === 0 ? 1500 : 1000); 

            setTimeout(() => {
                updateVisuals(stepIndex);
            }, Math.max(0, (time - audioContext.currentTime) * 1000));
        }

        function updateVisuals(stepIndex) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => c.classList.remove('active'));
            document.getElementById('beat-dot').classList.remove('pulse');

            if (cards[stepIndex]) {
                cards[stepIndex].classList.add('active');
            }

            const dot = document.getElementById('beat-dot');
            dot.classList.add('pulse');
            setTimeout(() => dot.classList.remove('pulse'), 100);
        }

        function toggleGame() {
            if (levelChunks.length === 0) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼"); return; }
            if (!isPlaying) {
                initAudio();
                isPlaying = true;
                currentStep = 0;
                nextNoteTime = audioContext.currentTime + 0.1;
                scheduler();
                const btn = document.getElementById('startBtn');
                btn.innerText = "åœæ­¢ (Stop)";
                btn.style.backgroundColor = "#ff4444";
            } else {
                stopGame();
            }
        }

        function stopGame() {
            isPlaying = false;
            cancelAnimationFrame(timerID);
            const btn = document.getElementById('startBtn');
            btn.innerText = "é–‹å§‹éŠæˆ² (Start)";
            btn.style.backgroundColor = "#00ff88";
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        }
    </script>
</body>
</html>
